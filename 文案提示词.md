作为一名专业的少儿绘本馆老师，我非常理解阅读打卡系统的核心目的：**激发孩子的阅读兴趣、培养持之以恒的阅读习惯，并通过正向反馈让孩子获得成就感。**

以下是为您精心编写的 CloudCode 编程提示词，它包含了清晰的目标、详细的功能点、数据模型和示例代码片段。您可以将此提示词直接用于支持 CloudCode 的云服务（如 LeanCloud、知晓云等）来快速构建系统。

---

### **少儿绘本阅读“悦读之旅”打卡系统**

#### **1. 项目概述与目标**

*   **项目名称：** 悦读之旅打卡系统
*   **核心目标：**
    1.  **趣味化激励：** 将阅读打卡游戏化，通过积分、徽章、排行榜等机制激励孩子。
    2.  **习惯养成：** 通过连续打卡记录，鼓励孩子坚持每日阅读。
    3.  **家园共育：** 允许家长/老师上传打卡记录、添加评论，共同见证孩子成长。
    4.  **数据可视化：** 为孩子和家长提供清晰的阅读数据看板（如总阅读本数、连续打卡天数等）。

#### **2. 数据模型设计（Class/Table Design）**

我们需要在数据库中创建以下几张表：

*   **`_User` (系统默认用户表)**
    *   扩展字段（如需要）：`childName` (孩子昵称)， `avatar` (头像)， `parentName` (家长姓名)等。

*   **`Book` (绘本信息表)**
    *   `ISBN` (String)： 图书ISBN，可用于从外部API获取信息。
    *   `title` (String)： 绘本标题。
    *   `author` (String)： 作者。
    *   `publisher` (String)： 出版社。
    *   `coverImage` (File)： 封面图。
    *   `difficultyLevel` (Number)： 难度等级（1-5星）。
    *   `tags` (Array)： 标签，如“情绪”，“科普”，“友谊”。

*   **`ReadingLog` (阅读打卡记录表) - 核心表**
    *   `child` (Pointer -> `_User`)： 打卡的孩子。
    *   `book` (Pointer -> `Book`)： 阅读的绘本。
    *   `readingDate` (Date)： 阅读日期（非常重要，用于计算连续打卡）。
    *   `duration` (Number)： 阅读时长（分钟）。
    *   `parentComment` (String)： 家长的点评/记录的孩子感想。
    *   `childComment` (String)： 大一点的孩子可以自己输入感想。
    *   `voiceNote` (File)： 孩子朗读的语音记录（可选）。
    *   `photo` (File)： 阅读时的照片或绘本内页照片（可选）。
    *   `isValid` (Boolean)： 标记此条记录是否有效（用于管理员审核）。

*   **`Achievement` (成就徽章表)**
    *   `name` (String)： 徽章名称，如“阅读小新星”、“连续打卡王”。
    *   `description` (String)： 获取条件描述。
    *   `icon` (File)： 徽章图标。

*   **`UserAchievement` (用户成就关联表)**
    *   `user` (Pointer -> `_User`)： 用户。
    *   `achievement` (Pointer -> `Achievement`)： 成就。
    *   `achievedAt` (Date)： 获得时间。

#### **3. CloudCode 云函数实现 (核心逻辑)**

以下是需要编写的关键云函数：

**云函数 1： `submitReadingLog` - 提交阅读打卡**

*   **功能：** 处理打卡提交，并自动计算连续打卡天数、检查成就解锁。
*   **触发：** 客户端调用。
*   **参数：** `bookId`， `readingDate`， `duration`， `comment` 等。
*   **云函数代码逻辑：**
    1.  验证用户是否已登录。
    2.  创建新的 `ReadingLog` 记录并保存。
    3.  **（关键）调用 `checkContinuousDays` 函数**，更新用户的连续打卡天数（可以存储在 `_User` 表的一个字段里，如 `continuousDays`）。
    4.  **（关键）调用 `checkAchievements` 函数**，检查用户是否达成了新的成就（如“首次打卡”、“连续打卡7天”）。
    5.  返回打卡成功信息及可能解锁的成就。

```javascript
// 伪代码示例 (基于 LeanCloud)
Cloud.define("submitReadingLog", async function(request) {
  const { bookId, readingDate, duration, parentComment } = request.params;
  const currentUser = request.currentUser;
  if (!currentUser) throw new Error("未登录");

  // 1. 保存打卡记录
  const ReadingLog = AV.Object.extend('ReadingLog');
  const newLog = new ReadingLog();
  newLog.set('child', currentUser);
  newLog.set('book', AV.Object.createWithoutData('Book', bookId));
  newLog.set('readingDate', new Date(readingDate));
  newLog.set('duration', duration);
  newLog.set('parentComment', parentComment);
  newLog.set('isValid', true); // 默认有效，管理员可后期修改

  await newLog.save();

  // 2. 计算连续打卡
  await checkContinuousDays(currentUser);

  // 3. 检查成就
  const unlockedAchievements = await checkAchievements(currentUser);

  return {
    success: true,
    logId: newLog.id,
    unlockedAchievements: unlockedAchievements
  };
});
```

**云函数 2： `checkContinuousDays` - 计算连续打卡天数**

*   **功能：** 私有函数，被 `submitReadingLog` 调用。查询用户最近的打卡记录，计算连续天数。
*   **逻辑：**
    1.  查询该用户所有有效的 `ReadingLog`，按 `readingDate` 倒序排列。
    2.  从今天（或最近的打卡日）开始往前推，检查日期是否连续。
    3.  将最终计算出的 `continuousDays` 值更新到对应用户的属性上。

**云函数 3： `checkAchievements` - 检查并解锁成就**

*   **功能：** 私有函数，根据用户当前的阅读数据（总打卡次数、连续天数、阅读绘本总量等）判断是否解锁新成就。
*   **逻辑：**
    1.  获取用户的总阅读次数、连续天数等。
    2.  查询 `Achievement` 表，找出所有用户尚未获得且已达到条件的成就。
    3.  在 `UserAchievement` 表中创建新的关联记录。
    4.  返回本次解锁的成就列表。

**云函数 4： `getChildReadingReport` - 获取孩子阅读报告**

*   **功能：** 为家长端或个人中心提供数据看板。
*   **触发：** 客户端调用。
*   **返回数据：**
    *   `totalBooksRead`: 阅读绘本总数。
    *   `totalReadingMinutes`: 总阅读时长。
    *   `currentContinuousDays`: 当前连续打卡天数。
    *   `longestContinuousDays`: 历史最长连续天数。
    *   `recentLogs`: 最近的打卡记录。
    *   `achievements`: 已获得的徽章列表。

#### **4. 钩子函数建议**

*   **BeforeSave - `ReadingLog`:** 在保存打卡记录前，校验数据合法性，例如防止同一本书在同一天重复打卡（可根据业务需求决定是否允许）。

#### **5. 安全与权限**

*   在数据库的服务端设置中，确保所有 Class 的权限设置正确。例如，`ReadingLog` 行级权限应设置为：`child` 对应的用户可读可写，其他人不可读写。
*   云函数内部务必使用 `request.currentUser` 进行用户身份验证。

---

**总结与给开发者的建议：**

这个提示词提供了一个完整的、可扩展的框架。您可以从最小可行产品开始，先实现核心的打卡和连续天数计算功能，然后再逐步添加徽章系统、语音照片等富媒体功能。

最重要的是，整个系统的设计要充满童趣和鼓励性，让每一次打卡都成为孩子“悦读之旅”上的一个美好里程碑。祝您开发顺利！